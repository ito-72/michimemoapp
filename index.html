<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>ã¿ã¡ã‚ã‚‚</title>
  <link rel="stylesheet" href="style.css">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#ffffff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
  <meta name="theme-color" content="#000000" media="(prefers-color-scheme: dark)">
  <link rel="manifest" href="/manifest.json">
</head>

<body>
  <!-- âœ… ãƒ•ãƒƒã‚¿ãƒ¼å›ºå®šã®ç¾åœ¨åœ°é€ä¿¡ãƒœã‚¿ãƒ³ -->
  <button id="postButton" class="floating-circle-button">ç¾åœ¨åœ°<br>é€ä¿¡</button>

  <!-- âœ… çµæœè¡¨ç¤ºãƒœãƒƒã‚¯ã‚¹ -->
  <div id="resultBox">ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>

  <!-- âœ… æ®‹ã‚Šã®ãƒœã‚¿ãƒ³ãŸã¡ -->
  <button id="distanceButton">ä»Šé€±ã®è·é›¢ã‚’è¨˜è¼‰</button>
  <button id="showDistanceByDay">è©²å½“æ—¥ã®è·é›¢ã‚’è¡¨ç¤º</button>

  <!-- âœ… APIä½¿ç”¨çŠ¶æ³è¡¨ç¤º -->
  <div id="apiUsageInfo">APIä½¿ç”¨çŠ¶æ³ã‚’å–å¾—ä¸­...</div>

  <!-- âœ… ã‚¿ãƒ–ã‚¨ãƒªã‚¢ -->
  <div id="tabArea">
    <div id="yearTabs" class="tab-group"></div>
    <div id="monthTabs" class="tab-group"></div>
    <div id="periodTabs" class="tab-group"></div>
    <div id="dayTabs" class="tab-group"></div>
  </div>

  <script>
    let sheetData = [];
    let selectedYear = null;
    let selectedMonth = null;
    let selectedPeriod = null;

    // âœ… ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥
    function showToast(message) {
      const toast = document.createElement("div");
      toast.className = "toast";
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2500);
    }

    // âœ… ç¾åœ¨åœ°ã‚’é€ä¿¡
    document.getElementById("postButton").addEventListener("click", async () => {
      const resultBox = document.getElementById("resultBox");

      if (!navigator.geolocation) {
        resultBox.textContent = "ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ä½ç½®æƒ…å ±ãŒä½¿ãˆã¾ã›ã‚“ã€‚";
        return;
      }

      navigator.geolocation.getCurrentPosition(
        async (pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;

          const res = await fetch("/api/recordLocation", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ lat, lng })
          });

          const result = await res.json();
          resultBox.textContent = `ğŸ“ ${result.message}`;
          showToast("é€ä¿¡ã—ã¾ã—ãŸ âœ…");
          updateApiUsageDisplay();
        },
        (err) => {
          resultBox.textContent = `ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—: ${err.message}`;
        }
      );
    });

    // âœ… ä»Šé€±ã®è·é›¢ã‚’è¨˜è¼‰
    document.getElementById("distanceButton").addEventListener("click", async () => {
      const resultBox = document.getElementById("resultBox");
      resultBox.textContent = "è¨ˆç®—ä¸­ã§ã™...";

      const res = await fetch("/api/calculateWeeklyDistance", {
        method: "POST"
      });

      const result = await res.json();
      resultBox.textContent = `ğŸš´â€â™€ï¸ ${result.message}`;
      updateApiUsageDisplay();
    });

    // âœ… æ—¥ã‚¿ãƒ–ã®ç”Ÿæˆã¨è¡¨ç¤º
    document.getElementById("showDistanceByDay").addEventListener("click", async () => {
      const resultBox = document.getElementById("resultBox");
      resultBox.textContent = "ã‚·ãƒ¼ãƒˆä¸€è¦§ã‚’å–å¾—ä¸­...";

      try {
        const res = await fetch("/api/getSheetNames", { method: "POST" });
        const result = await res.json();
        sheetData = result.sheetNames;

        const years = [...new Set(
          sheetData.map(name => name.match(/^\d{4}/)).filter(Boolean).map(match => match[0])
        )];

        const yearTabs = document.getElementById("yearTabs");
        yearTabs.innerHTML = "";
        document.getElementById("monthTabs").innerHTML = "";
        document.getElementById("periodTabs").innerHTML = "";
        document.getElementById("dayTabs").innerHTML = "";

        years.forEach(year => {
          const btn = document.createElement("button");
          btn.textContent = `${year}å¹´`;
          btn.className = "tab-button";
          btn.addEventListener("click", () => {
            selectedYear = year;
            updateSelectedTab(yearTabs, btn);
            resultBox.textContent = `ğŸ—“ï¸ ${year}å¹´ãŒé¸æŠã•ã‚Œã¾ã—ãŸ`;

            const monthMatches = sheetData.filter(name => name.startsWith(year)).map(name => {
              const match = name.match(/(\d{1,2})æœˆ/);
              return match ? match[1] : null;
            }).filter(Boolean);

            const uniqueMonths = [...new Set(monthMatches)];
            const monthTabs = document.getElementById("monthTabs");
            monthTabs.innerHTML = "";
            document.getElementById("periodTabs").innerHTML = "";
            document.getElementById("dayTabs").innerHTML = "";

            uniqueMonths.forEach(month => {
              const mBtn = document.createElement("button");
              mBtn.textContent = `${month}æœˆ`;
              mBtn.className = "tab-button";
              mBtn.addEventListener("click", () => {
                selectedMonth = month;
                updateSelectedTab(monthTabs, mBtn);
                resultBox.textContent = `ğŸ“† ${year}å¹´ ${month}æœˆãŒé¸æŠã•ã‚Œã¾ã—ãŸ`;

                const periodMatches = sheetData
                  .filter(name => name.startsWith(`${year}å¹´${month}æœˆ`))
                  .map(name => {
                    const match = name.match(/æœˆ(\d{1,2}-\d{1,2})/);
                    return match ? match[1] : null;
                  })
                  .filter(Boolean);

                const uniquePeriods = [...new Set(periodMatches)];
                const periodTabs = document.getElementById("periodTabs");
                periodTabs.innerHTML = "";
                document.getElementById("dayTabs").innerHTML = "";

                uniquePeriods.forEach(period => {
                  const pBtn = document.createElement("button");
                  pBtn.textContent = `${period}æ—¥`;
                  pBtn.className = "tab-button";
                  pBtn.addEventListener("click", async () => {
                    selectedPeriod = period;
                    updateSelectedTab(periodTabs, pBtn);
                    resultBox.textContent = `ğŸ“Š ${year}å¹´${month}æœˆ${period}æ—¥ã®æœŸé–“ãŒé¸æŠã•ã‚Œã¾ã—ãŸï¼ˆå–å¾—ä¸­...ï¼‰`;

                    const sheetName = `${year}å¹´${month}æœˆ${period}`;
                    const res = await fetch("/api/getAvailableDays", {
                      method: "POST",
                      headers: { "Content-Type": "application/json" },
                      body: JSON.stringify({ sheetName })
                    });
                    const result = await res.json();

                    const dayTabs = document.getElementById("dayTabs");
                    dayTabs.innerHTML = "";

                    result.days.forEach(day => {
                      const dBtn = document.createElement("button");
                      dBtn.textContent = `${day}æ—¥`;
                      dBtn.className = "tab-button";
                      dBtn.addEventListener("click", async () => {
                        updateSelectedTab(dayTabs, dBtn);
                        resultBox.textContent = `ğŸ“ ${day}æ—¥ã®è·é›¢ã‚’é›†è¨ˆä¸­...`;

                        const res = await fetch("/api/getTotalDistanceForDay", {
                          method: "POST",
                          headers: { "Content-Type": "application/json" },
                          body: JSON.stringify({
                            mode: "getTotalDistanceForDay",
                            sheetName: `${selectedYear}å¹´${selectedMonth}æœˆ${selectedPeriod.replace("æ—¥", "")}`,
                            day: String(day).replace("æ—¥", "")
                          })
                        });

                        const result = await res.json();
                        resultBox.textContent = `${selectedYear}å¹´${selectedMonth}æœˆ${day}æ—¥ã®èµ°è¡Œè·é›¢ï¼š${result.total} km`;
                      });
                      dayTabs.appendChild(dBtn);
                    });
                  });
                  periodTabs.appendChild(pBtn);
                });
              });
              monthTabs.appendChild(mBtn);
            });
          });
          yearTabs.appendChild(btn);
        });

        resultBox.textContent = "âœ… å¹´ã‚¿ãƒ–ã‚’ç”Ÿæˆã—ã¾ã—ãŸ";
      } catch (err) {
        console.error("âŒ ã‚¨ãƒ©ãƒ¼:", err);
        resultBox.textContent = "ã‚·ãƒ¼ãƒˆå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
      }
    });

    function updateSelectedTab(container, selectedButton) {
      [...container.children].forEach(btn => btn.classList.remove("selected"));
      selectedButton.classList.add("selected");
    }

    async function updateApiUsageDisplay() {
      try {
        const res = await fetch("/api/checkApiUsage", { method: "POST" });
        const result = await res.json();
        document.getElementById("apiUsageInfo").textContent =
          `ä»Šæ—¥ã®APIä½¿ç”¨å›æ•°ï¼š${result.count}/${result.limit}`;
      } catch (err) {
        console.error("APIä½¿ç”¨çŠ¶æ³ã®å–å¾—ã«å¤±æ•—:", err);
        document.getElementById("apiUsageInfo").textContent = "APIä½¿ç”¨çŠ¶æ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ";
      }
    }

    window.onload = updateApiUsageDisplay;
  </script>
</body>
</html>
