<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>位置情報アプリ</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1>現在地と走行距離記録</h1>

  <!-- ✅ ボタンたち -->
  <button id="postButton">現在地を送信</button>
  <button id="distanceButton">今週の距離を記載</button>
  <button id="showDistanceByDay">該当日の距離を表示</button>

  <!-- ✅ 結果表示ボックス（統一） -->
  <div id="resultBox">ここに結果が表示されます</div>

  <!-- ✅ タブエリア -->
  <div id="tabArea">
    <div id="yearTabs" class="tab-group"></div>
    <div id="monthTabs" class="tab-group"></div>
    <div id="periodTabs" class="tab-group"></div>
    <div id="dayTabs" class="tab-group"></div>
  </div>

  <script>
    // ✅ 現在地を送信
    document.getElementById("postButton").addEventListener("click", async () => {
      const resultBox = document.getElementById("resultBox");

      if (!navigator.geolocation) {
        resultBox.textContent = "このブラウザでは位置情報が使えません。";
        return;
      }

      navigator.geolocation.getCurrentPosition(
        async (pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;

          const res = await fetch("/api/recordLocation", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ lat, lng })
          });

          const result = await res.json();
          resultBox.textContent = `\uD83D\uDCCD ${result.message}`;
        },
        (err) => {
          resultBox.textContent = `位置情報の取得に失敗: ${err.message}`;
        }
      );
    });

    // ✅ 今週の距離を記載
    document.getElementById("distanceButton").addEventListener("click", async () => {
      const resultBox = document.getElementById("resultBox");
      resultBox.textContent = "計算中です...";

      const res = await fetch("/api/calculateWeeklyDistance", {
        method: "POST"
      });

      const result = await res.json();
      resultBox.textContent = `\uD83D\uDEB4\u200D♀️ ${result.message}`;
    });

    // ✅ 該当日の距離を表示（年タブ生成）
    document.getElementById("showDistanceByDay").addEventListener("click", async () => {
      const resultBox = document.getElementById("resultBox");
      resultBox.textContent = "シート一覧を取得中...";

      try {
        const res = await fetch("/api/getSheetNames", { method: "POST" });
        const result = await res.json();

        console.log("\uD83D\uDD0D シート一覧取得: ", result.sheetNames);

        if (!result.sheetNames || result.sheetNames.length === 0) {
          resultBox.textContent = "シートが存在しません。";
          return;
        }

        const years = [...new Set(
          result.sheetNames
            .map(name => name.match(/^\d{4}/))
            .filter(match => match)
            .map(match => match[0])
        )];

        const yearTabs = document.getElementById("yearTabs");
        yearTabs.innerHTML = "";

        years.forEach(year => {
          const btn = document.createElement("button");
          btn.textContent = `${year}年`;
          btn.className = "tab-button";
          btn.addEventListener("click", () => {
            resultBox.textContent = `🗓️ ${year}年が選択されました`;
            // 今後: 月タブをここで生成
          });
          yearTabs.appendChild(btn);
        });

        resultBox.textContent = "✅ 年タブを生成しました";

      } catch (err) {
        console.error("❌ エラー:", err);
        resultBox.textContent = "シート取得に失敗しました。";
      }
    });
  </script>
</body>
</html>
